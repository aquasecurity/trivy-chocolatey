name: Build and Push Chocolatey Package
# Start
on:
  workflow_dispatch: # Allows manual triggering
    inputs:
      version:
        description: 'The version to update to (leave empty to auto-detect latest)'
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write
  packages: write
  actions: read
  deployments: read
  id-token: write
  issues: write
  discussions: read
  pages: read
  repository-projects: read
  security-events: read
  attestations: read # Added this
  checks: write # Added this
  statuses: write # Added

jobs:
  # run the update script on ubuntu and push the changes to main branch
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set Trivy version from input
        id: set_version
        run: |
          # Remove "v" prefix if present
          incoming_version="${{ github.event.inputs.version }}"
          echo "version=${incoming_version#v}" >> $GITHUB_OUTPUT

      - name: Run update script
        run: |
          ./scripts/update.sh "${{ steps.set_version.outputs.version }}"

      - name: Commit and push changes
        run: |
          git add trivy.nuspec tools/chocolateyinstall.ps1
          git commit -m "Update package to latest version" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # on windows latest, build and push the package to chocolatey.org and myget.org
  build-and-push:
    runs-on: windows-latest
    needs: update
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main   

      - name: pack the project
        run: |
          choco apikey -k ${env:CHOCO_API_KEY} -s https://push.chocolatey.org/
          choco pack
          choco push -s https://push.chocolatey.org/
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}

